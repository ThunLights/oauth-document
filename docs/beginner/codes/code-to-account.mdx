---
sidebar_position: 2
title: リダイレクト時の処理
---

# リダイレクト時の処理

リダイレクト時に付属するcodeをアクセストークンに変換する方法を解説します。

## コールバック先に処理を追加する

まず以下のようにcodeがクエリとして付属しているかどうか確認するようにします。

コード(前章のコードのcallbackの部分を上書きするようにしてください)
```ts
app.get("/callback", async (c) => {
    const code = c.req.query("code");

    if (!code) {
        return c.json({
            content: "code not found"
        }, 404)
    }

    return c.json({
        content: "This is a test."
    }, 200)
});
```

codeの有無が確認できるようになったら次はそのcodeを元にアクセストークンを取得し、そのアクセストークンを使いアカウントデータを取得します。

その為に今回二つの関数を用意しました。

### codeをアクセストークンに変換するコード
```ts
const secret = "";
const domain = encodeURIComponent("");

async function codeToAcccessToken(code: string) {
    const url = `https://oauth.thunlights.com/check/code/${code}`;

    const response = await fetch(`${url}?secret=${secret}&domain=${domain}`, {
        method: "POST",
    });

    if (response.ok) {
        return await response.json();
    }

    return null;
}
```

### アクセストークンを元にアカウントデータを取得するコード
```ts
async function accessTokenToAccount(accessToken: string) {
    const response = await fetch(`https://oauth.thunlights.com/check/accessToken/${accessToken}`, {
        method: "POST",
    });

    if (response.ok) {
        return await response.json();
    }

    return null;
}
```

## アカウントデータ取得

上記のコードを合体させると以下のようになります。

```ts
const secret = "";
const domain = encodeURIComponent("");

async function codeToAcccessToken(code: string) {
    const url = `https://oauth.thunlights.com/check/code/${code}`;

    const response = await fetch(`${url}?secret=${secret}&domain=${domain}`, {
        method: "POST",
    });

    if (response.ok) {
        return await response.json();
    }

    return null;
}

async function accessTokenToAccount(accessToken: string) {
    const response = await fetch(`https://oauth.thunlights.com/check/accessToken/${accessToken}`, {
        method: "POST",
    });

    if (response.ok) {
        return await response.json();
    }

    return null;
}

app.get("/callback", async (c) => {
    const code = c.req.query("code");

    if (!code) {
        return c.json({
            content: "code not found"
        }, 404)
    }

    const data = await codeToAcccessToken(code);
    if (!data) {
        return c.json({
            content: "access token not found"
        }, 404)
    }

    const account = await accessTokenToAccount(data.accessToken);
    if (!account) {
        return c.json({
            content: "account not found"
        }, 404)
    }

    return c.json({ account }, 200)
});
```

こうすることによってクエリに付属するコードからアカウントデータを取得することが出来るのです。

このOauthを活用してアカウントシステムを構築するならデータベース等の知識も必要になりますが、ここで解説すると途轍もなく長くなってしまうので割愛させていただきます。
